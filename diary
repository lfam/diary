#!/bin/sh

do_git() {
	git rev-parse --git-dir 1> /dev/null 2>&1 &&
	git add $1 &&
	printf "Auto-commit of $1 by diary program\n" | git commit $1 -F - 
}

changed() {
	prepend_date $1 $3
	if diff "$1$2" "$1$3" >/dev/null 2>&1 ; then
		rm $1$2
		rm $1$3
		return 1
	else
		mv $1$2 $1
		rm $1$3
		return 0
	fi
}

prepend_date() {
	printf "$date\n\n" | cat - $1 > $1$2
}

safety() {
	warning="ERROR: the diary working files \'$1$2\' and/or \
\'$1$3' are present.
This is unexpected and probably not what you want.
Rename these files or pick another diary name besides $1 by editing \
\'$(command -v diary)\' and changing $1 to your new name.
"

	if { test -f $1$2 || test -f $1$3 ; }; then
		printf "$warning"
		return 1
	fi
}

main() {
	date="$(date +"%a,%e %b %G %H:%M:%S %z")"
	diary=.log
	swap=.swp
	diff=.diff

	if ! safety $diary $swap $diff ; then
		return 1
	fi

	test -f $diary || touch $diary
	prepend_date $diary $swap
	${EDITOR:-vi} $diary$swap
	if changed $diary $swap $diff ; then
		do_git $diary
	fi
}
main "$@"
