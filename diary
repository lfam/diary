#!/bin/sh

do_git() {
	git rev-parse --git-dir 1> /dev/null 2>&1 \
	&& git add "$1" \
	&& printf "Auto-commit of %s by diary script\n" "$1" | git commit "$1" -F -
}

changed() {
	prepend_date "$4" "$1" > "$3"
	if diff "$2" "$3" >/dev/null 2>&1 ; then
		rm "$2"
		rm "$3"
		return 1
	else
		mv "$2" "$1"
		rm "$3"
		return 0
	fi
}

prepend_date() {
	printf "%s\n\n" "$1" | cat - "$2"
}

safety() {
	if test -f "$1"; then
		cat <<-EOF 1>&2
		Swap file "$1" already exists! Aborting...
		EOF
		return 1
	fi
}

main() {
	readonly local date="$(date +"%a,%e %b %G %H:%M:%S %z")"
	readonly local diary=.log
	readonly local swap=${diary}.swp
	readonly local diff=${diary}.diff

	safety "$swap" || return 1
	safety "$diff" || return 1
	test -w "$diary" || touch "$diary" || return 1

	prepend_date "$date" "$diary" > "$swap"
	${EDITOR:-vi} "$swap"
	if changed "$diary" "$swap" "$diff" "$date" ; then
		do_git "$diary"
	fi
}
main
