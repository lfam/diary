#!/bin/sh

do_git() {
	git rev-parse --git-dir 1> /dev/null 2>&1 \
	&& git add $1 \
	&& printf "Auto-commit of $1 by diary script\n" | git commit $1 -F - 
}

changed() {
	prepend_date $1 $3
	if diff "$1$2" "$1$3" >/dev/null 2>&1 ; then
		return 1
	else
		return 0
	fi
}

prepend_date() {
	printf "$date\n\n" | cat - $1 > $1$2
}

safety() {
	if test -f "$1$2"; then
		cat <<-EOF 1>&2
		Swap file "$1$2" already exists! Aborting...
		EOF
		return 1
	fi
}

main() {
	readonly date="$(date +"%a,%e %b %G %H:%M:%S %z")"
	readonly diary=.log
	readonly swap=.swp
	readonly diff=.diff

	safety $diary $swap || return 1
	safety $diary $diff || return 1
	test -w $diary || touch $diary || return 1

	prepend_date $diary $swap
	${EDITOR:-vi} $diary$swap

	if changed $diary $swap $diff ; then
		mv $diary$swap $diary
		rm $diary$diff
		do_git $diary
	else
		rm $diary$swap
		rm $diary$diff
		test -s $diary || rm $diary
	fi
}
main
