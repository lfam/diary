#!/bin/sh

usage="Diary, for keeping a timestamped journal in a directory. If the
directory is a git repo, your edits will be checked into git.

Usage:	diary			# open your diary
	diary --help		# print this help page
"

do_git() {
	git rev-parse --git-dir 2> /dev/null &&
	git add $1 &&
	printf "Auto-commit of $1 by diary program\n" | git commit $1 -F - 
}

changed() {
	prepend_date $1 $3
	if diff "$1$2" "$1$3" >/dev/null 2>&1 ; then
		rm $1$2
		rm $1$3
		return 1
	else
		mv $1$2 $1
		rm $1$3
		return 0
	fi
}

prepend_date() {
	printf "$date\n\n" | cat - $1 > $1$2
}

main() {
	if [ "$1" = "-h" ] || [ "$1" = "--help" ] || [ "$1" = "-help" ]; then
		printf "$usage"
		return 0
	elif [ -n "$1" ]; then
		printf "$usage"
		return 1
	fi

	date="$(date +"%a,%e %b %G %H:%M:%S %z")"
	diary=.log

	test -f $diary || touch $diary
	prepend_date $diary .swp
	${EDITOR:-vi} $diary.swp
	if changed $diary .swp .diff ; then
		do_git $diary
	fi
}
main "$@"
